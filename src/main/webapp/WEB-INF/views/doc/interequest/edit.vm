<div  class="easyui-panel mainborder-Padding" data-options="fit:true,border:false">
    <div id="cc" class="easyui-layout" data-options="fit:true">
        <div data-options="region:'center'" class="mynoborder">
            <form id="editForm" method="post">
				<input name="id" id="id" type="hidden" value="$!{obj.id}"/>
				<input id="creatorId" name="creatorId" type="hidden" #if($obj) value="$!{obj.creatorId}" #else value="$!{currUser.id}" #end/>
				<input id="docEditable" name="docEditable" type="hidden" value="1"/>
				<input name="nextNodeId" id="nextNodeId" type="hidden" value=""/>
				<input name="nextDealers" id="nextDealers" type="hidden" value=""/>
				<input name="fileType" id="fileType" type="hidden" value="5"/>
				<input id="version_" name="version_" type="hidden" value="$!{obj.version_}"/>
				<input id="status" name="status" type="hidden" value="$!{obj.status}"/>
                <table class="table-edit"  width="99%" border="0" cellspacing="1" cellpadding="0">
                    <tr>
                        <td class="fix_td_title">&nbsp;</td>
                        <td class="fix_td_data">&nbsp;</td>
                        <td class="fix_td_title">&nbsp;</td>
                        <td class="fix_td_data">&nbsp;</td>
                    </tr>
                    <tr align="center">
                      <td class="bg-grey"><span><font color=red>*</font></span>标题</td>
					  <td class="bg-white" colspan="3">
						<input style="width:100%;" id="title" name="title" data-options="required:true,validType:'maxLength[200]'" class="easyui-textbox" value="$!{obj.title}"/>
					  </td>
                    </tr>
                    <tr>
						<td class="bg-grey">来文单位</td>
						<td colspan="3" class="bg-white">
							<textarea class="easyui-validatebox textareaborder" id="sendUnit" name="sendUnit" maxLength="240" cols="" style="resize:none;width:99%;height:50px;">$!{esc.html($!{obj.sendUnit})}</textarea>
						</td>
					</tr>
					<tr>
						<td class="bg-grey"><span><font color=red>*</font></span>请示事项</td>
						<td colspan="3" class="bg-white">
							<textarea class="easyui-validatebox textareaborder" data-options="required:true" id="suggestion" name="suggestion" maxLength="240" cols="" style="resize:none;width:99%;height:50px;">$!{esc.html($!{obj.suggestion})}</textarea>
						</td>
					</tr>
					<input type="hidden" name="flowId" id="flowId" value="$!{obj.flowId}"/>
					#*
                    <tr>
						<td class="bg-grey"><span><font color=red>*</font></span>选择流程</td>
						<td class="bg-white" colspan="3">
							#if($!{obj.status} == "0")
								<select name="flowId" id="flowId" class="easyui-combobox" data-options="editable:false,validType:{selectValid:' '}" panelheight="auto" style="width:170px;">
									<option value="">&nbsp;</option>
									#foreach($flow in $flowList)
										<option value="$flow.id" #if("$flow.id"=="$!obj.flowId") selected #end>$flow.flowName</option>
									#end
								</select>
							#elseif($!{curNode} && $!{curNode.flow})
								<input type="hidden" name="flowId" id="flowId" value="$!{curNode.flowId}">
									$!{curNode.flow.flowName}
							#end
  						</td>
					</tr>
					*#
					<tr>
						<td class="bg-grey">备注</td>
						<td colspan="3" class="bg-white">
							<textarea class="easyui-validatebox textareaborder" id="remark" name="remark" maxLength="240" cols="" style="resize:none;width:99%;height:50px;">$!{esc.html($!{obj.remark})}</textarea>
						</td>
					</tr>
					
					<tr>
						<td class="bg-grey">附件</td>
						<td colspan="3" class="bg-white">
							##附件id
							<input id="attach" name="attach" type="hidden" value=""/>
							<div class="filelistmulti" id="file-list-c">
								<a class="easyui-linkbutton btn-file-up" icon="icon-add" plain="true" select-type="otherFile" uploadurl="#defaultUploadUrl('interequestattach')" swfurl="$!{link.getContextPath()}/js/Moxie.swf">
									添加附件
								</a>
								<div id="other-file-c">

								</div>
							</div>
						</td>
					</tr>
            	</table>
				
				##附件可编辑
				#set($docIsEdit=true)
				##附件预览
				#parse("doc/fileparse/attachpreview.vm")
        	</form>
    	</div>
    	<div data-options="region:'south'" class="bottom-h">
			<div class="bottom-but">
				<ul>
					<li><a id="saveTemp" onclick="saveTemp()" class="new-but">保存</a></li>
					<li><a id="publish" onclick="selectFlows()" class="new-but">呈送</a></li>
					<li><a id="back" onclick="back()" class="new-but">关闭</a></li>
				</ul>
			</div>
		</div>
		<div id="selNodesWindow" class="easyui-window" title="提交到下一环节" style="width:350px;height:330px;padding:5px"
			data-options="closed:true,modal:true,minimizable:false,maximizable:false,collapsible:false">
		</div>
		#parse("selectdialog/selectFlows.vm")
	</div>
</div>

#@script()
<script type="text/javascript">

    var _baseUrl = '$link.getContextURL()';
	
	var selNodeId = "";

    //返回
    function back() {
        $.messager.confirm('提示','关闭将不保存编辑内容，是否要关闭？',function (r) {
           if(r){
    	      top.CC.closeCurTab();
    	   }
        });
    }

    //呈送
    function openNodes(){
       var flowId = $("#flowId").val();
	   if($("#editForm").form('validate')) {
			hideWebOffice('WebOffice2009');
			
	        $('#selNodesWindow').window('open');
	        $('#selNodesWindow').window('refresh',"$link.getContextURL()/workflow/event/getNextNodes?startflow=1&nodeId=N201&flowId=" + flowId);
	   }
    }

    //暂存
    function saveTemp(){

    	var file = "$!{docpath}/$!{docname}";
    	if($("#editForm").form('validate')) {
      		// 保存
      		top.CC.loading('保存中...');
     		$.post("$link.getContextURL()/doc/event/saveTemp.json",$("#editForm").serialize(),function(result){
       	 		top.CC.loaded();
        		if(result.success){
          			top.CC.messager({ title:'提示', msg:'保存成功！' });
          			var title = top.CC.getCurTab().panel('options').title;
          			top.CC.addTab({title:'暂存公文', url:'$link.getContextURL()/doc/event/listTmp'})
          			top.CC.closeTab(title);
        		}else{
          			top.CC.messager({ title:'提示', msg:result.message });
        		}
      		});
    	}
    }
	
	// 提交-------------------------------------------------------------------------------------------
  	function start() {
    	if($("#editForm").form('validate')) {
      		var nodeId = selNodeId;
      		var flowId = $("#flowId").val();
			var _callbackname = "fnSelectMansCallback";
      		var _url = "$link.getContextURL()/workflow/event/selectNextTask?flowId=" + flowId + "&nodeId=" + nodeId;
			var _callback_fn = window[_callbackname];
			var dfn = top.window.openSelectDialogFrameDialog;
      		if (typeof dfn === "function") {
        		dfn(_url, _callback_fn);
      		}
    	}
  	}
	
	function fnSelectMansCallback(obj){
    	//写入下一环节
    	$('#nextNodeId').val(obj.nextNode);
   	 	//写入下一环节的办理人（多个用逗号分开）
    	$('#nextDealers').val(obj.userIds);
	
    	// 提交，启动流程
    	top.CC.loading('呈送中...');
    	$.post("$link.getContextURL()/doc/event/dealStartflow",$("#editForm").serialize(),function(result){
      		top.CC.loaded();
      		if(result.success){
        		top.CC.messager({ title:'提示', msg:'公文呈送成功！' });
        		var title = top.CC.getCurTab().panel('options').title;
        		top.CC.addTab({ title:'内部请示查询',url:'$link.getContextURL()/doc/interequest/tasklist' });
        		top.CC.closeTab(title);
      		}else{
        		top.CC.messager({ title:'提示', msg:result.message });
      		}
    	});
  	}
</script>
#end