<div class="easyui-panel mainborder-Padding" data-options="fit:true,border:false">
<div id="cc" class="easyui-layout" data-options="fit:true">
  <div data-options="region:'center'" class="mynoborder">
    #parse("doc/sendfile/inner/data_edit.vm")
  </div>
  <div data-options="region:'south'" style="height:52px">
    <div class="bottom-but">
      <ul>
        #if("$!{obj.status}"=="0" || "$!{obj.status}"=="")
        #if($!{obj.id})
	      <li><a id="saveTemp" onclick="doDel()" class="new-but">删除</a></li>
	    #end
        <li><a id="saveTemp" onclick="saveTemp()" class="new-but">保存</a></li>
        #end
        <li><a id="publish" onclick="selectFlows()" class="new-but">呈送</a></li>
        <li><a id="back" onclick="back()" class="new-but">关闭</a></li>
      </ul>
    </div>
</div>
</div>
  <div id="selNodesWindow" class="easyui-window" title="提交到下一环节" style="width:350px;height:330px;padding:5px"
        data-options="closed:true,modal:true,minimizable:false,maximizable:false,collapsible:false">
  </div>
#parse("selectdialog/selectFlows.vm")
</div>
#@script()
<script type="text/javascript">
  var _baseUrl = '$link.getContextURL()';
  //返回
  function back() {
    $.messager.confirm('提示','关闭将不保存编辑内容，是否要关闭？',function (r) {
       if(r){
	      top.CC.closeCurTab();
	   }
    });
  }

  function checkCate() {
    var cate = $("input[name='docCate']:checked")
    if(cate.length<=0){
        $.messager.alert('提示','请选择公文形式！','info');
        return 0;
    } else {
        return 1;
    }
  }

  //暂存
  function saveTemp(){
    //先主动切换回第一页，以免控件出错
    $("#docTab").tabs('select',0);

    if (checkCate() == 0) return false;

    var file = "$!{docpath}/$!{docname}";
    if($("#editForm").form('validate')) {
      // 保存
      top.CC.loading('保存中...');
      $.post("$link.getContextURL()/doc/event/saveTemp.json",$("#editForm").serialize(),function(result){
        top.CC.loaded();
        if(result.success){
          top.CC.messager({ title:'提示', msg:'保存成功！' });
          var title = top.CC.getCurTab().panel('options').title;
          top.CC.addTab({title:'暂存公文', url:'$link.getContextURL()/doc/event/listTmp'})
          top.CC.closeTab(title);
        }else{
          top.CC.messager({ title:'提示', msg:result.message });
        }
      });
    }
  }

	//选择环节-------------------------------------------------------------------------------------------
	function openNodes(){
		if (checkCate() == 0) return false;
		//var flowId = $('#flowId').combobox('getValue');
		var flowId = $("#flowId").val();
		if($("#editForm").form('validate')) {
			hideWebOffice('WebOffice2009');
			
	        $('#selNodesWindow').window('open');
	        $('#selNodesWindow').window('refresh',"$link.getContextURL()/workflow/event/getNextNodes?startflow=1&nodeId=N201&flowId=" + flowId);
	   }
	}

  // 提交-------------------------------------------------------------------------------------------
  function start() {
    //先主动切换回第一页，以免控件出错
    $("#docTab").tabs('select',0);
    if($("#editForm").form('validate')) {
      var nodeId = selNodeId;
	  //var flowId = $('#flowId').combobox('getValue');
	  var flowId = $("#flowId").val();
      var _callbackname = "fnSelectMansCallback";
      var _callbackname1 = "showWebOffice";
      var _url = "$link.getContextURL()/workflow/event/selectNextTask?flowId=" + flowId + "&nodeId=" + nodeId;
      var _callback_fn = window[_callbackname];
      var _callback_fn1 = window[_callbackname1];
      var dfn = top.window.openSelectDialogFrameDialog;
      if (typeof dfn === "function") {
        dfn(_url, _callback_fn,_callback_fn1);
      }
    }
  }
  //-----------------------------------------------------------------------------------------------


  // 提交
  function save() {
    //先主动切换回第一页，以免控件出错
    $("#docTab").tabs('select',0);
    if($("#editForm").form('validate')) {
      var nodeId = "N201";
	  //var flowId = $('#flowId').combobox('getValue');
	  var flowId = $("#flowId").val();
	  var _callbackname = "fnSelectMansCallback";
      var _url = "$link.getContextURL()/workflow/event/selectNextTask?nodeId=" + nodeId+"&flowId="+flowId;
      var _callback_fn = window[_callbackname];
      var dfn = top.window.openSelectDialogFrameDialog;
      if (typeof dfn === "function") {
        dfn(_url, _callback_fn);
      }
    }
  }
  // 删除
  function doDel() {
    $.messager.confirm('提示','确定要删除公文吗?',function (r) {
       if(r){
	      top.CC.loading("删除中...");
	      $.post("$link.getContextURL()/doc/event/deleteflow", {id:$("#id").val()}, function(result){
	        top.CC.loaded();
	        if(result.success){
	          var title = top.CC.getCurTab().panel('options').title;
	          top.CC.addTab({ title:'待办公文',url:'$link.getContextURL()/doc/event/tasklist' });
	          top.CC.messager({ title:'提示', msg:'删除成功！' });
	          top.CC.closeTab(title);
	        }else{
	          top.CC.messager({ title:'提示', msg:result.error });
	        }
	      });
	   }
    });
  }

  function fnSelectMansCallback(obj){

    //写入下一环节
    $('#nextNodeId').val(obj.nextNode);
    //写入下一环节的办理人（多个用逗号分开）
    $('#nextDealers').val(obj.userIds);
	
    // 提交，启动流程
    top.CC.loading('呈送中...');
    $.post("$link.getContextURL()/doc/event/dealStartflow",$("#editForm").serialize(),function(result){
      top.CC.loaded();
      if(result.success){
        top.CC.messager({ title:'提示', msg:'公文呈送成功！' });
        var title = top.CC.getCurTab().panel('options').title;
        top.CC.addTab({ title:'待办公文',url:'$link.getContextURL()/doc/event/tasklist' });
        top.CC.closeTab(title);
      }else{
        top.CC.messager({ title:'提示', msg:result.message });
      }
    });
  }


  $('#title').focus();

</script>
#end
