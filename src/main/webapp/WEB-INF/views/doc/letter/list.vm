<div class="easyui-panel mainborder-Padding" data-options="fit:true,border:false">
    <div class="easyui-layout" fit="true">
        <div id="tb" class="top-menu datagrid-toolbar toolbar-borderbottom">
            #if("$type" == "send")
            <a href="javascript:;" class="easyui-linkbutton" iconCls="icon-remove" onclick="deleteLetter()" plain="true">删除</a>
            <i></i>
            #end
            <a  onclick="$('#searchDialog').css('display','block');$('#searchDialog').window('center');$('#searchDialog').window('open');"
                 class="easyui-linkbutton l-btn-plain-search" data-options="iconCls:'icon-search',plain:true">查询</a>
            <a  onclick="top.CC.closeCurTab()"
                 class="easyui-linkbutton l-btn-plain-quit" data-options="iconCls:'icon-quit-small',plain:true">关闭</a>
        </div>
        <div class="cc-tableWrap" data-options="region:'center',border:false">
            <table id="letter_dg">
                <thead>
                <tr>
                    #if("$type" == "send")
                    <th  data-options="field:'ck',checkbox:true"></th>
                    #end
                    ##<th style="width:5"  data-options="field:'urgencyLevelKey',formatter:fmUrgencyLevelKey"><img src='images/ji.gif' title='紧急程度'/></th>
                    <th style="width:5" data-options="field:'attachFlagKey',formatter:fmAttachFlagKey"><img src='images/attach.png' title='有附件'/></th>
                    #if("$type" == "send")
                    <th data-options="field:'title',width:50,formatter:fmTitle">标题</th>
                    <th data-options="field:'incepterDept',width:25,formatter:showTitle">接收部门</th>
                    <th data-options="field:'letterCode',width:10">编号</th>
                    <th data-options="field:'expiryDate',width:10">处理时限</th>
                    #else
                    <th data-options="field:'title',width:50,formatter:fmTitle">标题</th>
                    <th data-options="field:'sendDep',formatter:fmSendDep,width:25,formatter:showTitle">发送部门</th>
                    <th data-options="field:'expiryDate',width:10">处理时限</th>
                    <th data-options="field:'statusValue',width:8">状态</th>
                    #end
                </tr>
                </thead>
            </table>
        </div>
        <div id="searchDialog" class="easyui-dialog  dialog-tc" title="查询条件" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,buttons:'#bnts'"
             style="width:500px;height:320px;padding:20px 10px; background-color:#f4f4f4;display:none">
            <form id="queryForm">
                <table width="100%" border="0" cellspacing="0" cellpadding="0">
                    <tr>
                        <td align="right">标题：</td>
                        <td><input id="title" name="$qc.like('title')" style="width:350px;" class="easyui-textbox" /></td>
                    </tr>
                </table>
             </form>
            <div id="bnts" style="top:0px; height:25px; width:auto;">
                <a class="new-but" onclick="formSerach()">确定</a>
                <a class="new-but" onclick="reset()">重置</a>
            </div>
        </div>
    </div>
</div>
#@script()
<script type="text/javascript">
   function formSerach() {
        $('#searchDialog').window('close');
        $('#letter_dg').datagrid('reload');
    }

    function reset(){
        var _qf = $("#queryForm");
        _qf.form("clear");
        $(".easyui-combobox",_qf).each(function(){
            $(this).combobox("select"," ");
        });
    }

    function addPageCondition(param){
        $.extend(param,getConditions());
    }

    function getConditions(){
        var f = $("#queryForm").serializeArray();
        var searchConditions = {};
        for(var i = 0;i< f.length;i++){
            searchConditions[f[i].name] = f[i].value;
        }
        return searchConditions;
    }

    $(document).ready(function(){
        //初始化datagrid
        $("#letter_dg").datagrid({
            fitColumns:true,//列宽自适应
            fit:true,//自适应
##            nowrap:false,
            rownumbers:true,//行号
            pagination:true,//显示分页工具条
            #if("$type" == "send")
            singleSelect:false,
            #else
            singleSelect:true,
            #end
            toolbar:'#tb',//工具条
            pageSize:20,//每页记录数
            pageList:[20,30],//可选每页记录数
            url:#if("$type" == "send") "$link.getContextURL()/doc/letter/listSendLtter.json" #else "$link.getContextURL()/doc/letter/listReceiveLtter.json"  #end ,//获取数据的url
            onBeforeLoad:addPageCondition//提交查询时追加翻页条件
        });
    });
    //
    function fmUrgencyLevelKey(value){
        if(value == "2" || value == "3"){
            return "<img src='images/ji.gif' title='紧急'/>";
        }else{
            return "";
        }
    }
    function fmAttachFlagKey(value){
        if(value == "1"){
            return "<img src='images/attach.png' title='有附件'/>";
        }else{
            return "";
        }
    }
    function fmSendDep(value,row){
        if(row.sendUnit && value){
            return row.sendUnit+">"+ value;
        }else{
            return value;
        }
    }
    function showTitle(value){
        if(value){
            return '<span title="'+value+'">'+value+'</span>'
        }
    }
    function fmTitle(value,row){
        if(value && row.letterId){
            var content = "<a href='javascript:;' class='font-titlecolor' onclick=toDetail('"+row.letterId+"') title='"+value+"'>"+value;
            if (row.urgencyLevelKey == "2") {
                content += '<img src="images/doc/icon-urgent.png" title="急件" class="tips-icon"/>';
            } else if (row.urgencyLevelKey == "1") {
                content += '<img src="images/doc/icon-emergency.png" title="特急" class="tips-icon"/>';
            }
            content += "</a>";
            return content;
        }
    }
    function toDetail(id){
        top.CC.addTab({title:'部门函件',url:"$link.getContextURL()/doc/letter/detail?id="+id});
    }
    function deleteLetter(){
        var selects = $("#letter_dg").datagrid("getSelections");
        if(selects && selects.length>0){
            $.messager.confirm('提示', '确定要删除选中的函件吗？', function(r){
                if (r){
                    var ids = "";
                    for(var i = 0;i<selects.length;i++){
                        if(i == selects.length-1){
                            ids += selects[i].letterId;
                        }else{
                            ids += selects[i].letterId + ",";
                        }
                    }
                    $.post("$link.getContextURL()/doc/letter/delete.json",{ids:ids},function(result){
                        if(result){
                            top.CC.messager({title:"提示",msg:"删除成功。"});
                            window.location.reload();
                        }else{
                            top.CC.messager({title:"提示",msg:"删除失败！"});
                        }
                    });
                }
            });
        }else{
            top.CC.messager({title:"提示",msg:"请选择需要删除的函件。"});
        }

    }

</script>
#end
