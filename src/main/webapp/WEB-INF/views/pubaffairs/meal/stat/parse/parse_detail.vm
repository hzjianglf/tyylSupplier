<link rel="stylesheet" type="text/css" href="$link.getContextURL()/css/doc/listicon.css"/>
<div id="tb" class="top-menu datagrid-toolbar toolbar-borderbottom">
	<a href="javascript:;" id="doFinish" class="easyui-linkbutton" iconCls="icon-add" plain="true">办结</a>
	<a href="javascript:;" id="doBack" class="easyui-linkbutton" iconCls="icon-edit" plain="true">退回</a>
	<i></i>
    <a onclick="$('#searchDialog').css('display','block');$('#searchDialog').window('center');$('#searchDialog').window('open');"
        class="easyui-linkbutton l-btn-plain-search" data-options="iconCls:'icon-search',plain:true">查询</a>
	
</div>
            
<table id="dg" data-options="nowrap:false" style="width:99%;">
	<thead>
		<tr>
			<th field="ck" data-options="checkbox:true"></th>
			<th style="width:10%" data-options="field:'mealUserName'">姓名</th>
			<th style="width:20%" data-options="field:'mealDeptName'">部门</th>
			<th style="width:10%" data-options="field:'mealPlace'">用餐地点</th>
			<th style="width:10%" data-options="field:'mealType'">用餐类型</th>
			<th style="width:10%" data-options="field:'mealDateShow'">用餐日期</th>
			<th style="width:10%" data-options="field:'status',formatter:statusShow">状态</th>
		</tr>
	</thead>
</table>
<div  id="searchDialog" class="easyui-dialog  dialog-tc" title="查询条件" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,buttons:'#bnts'"
		style="width:500px;height:260px;padding:20px 10px; background-color:#f4f4f4;display:none;">
	<form id="queryForm">
		<input id="mealType" name="mealType" type="hidden" value="$!{mealType}"/>
		<input id="mealDate" name="mealDate" type="hidden" value="$!{mealDate}"/>
		<table width="100%" border="0" cellspacing="0" cellpadding="0">
			<tr>
				<td align="right">姓名：</td>
				<td align="left" colspan="3">
					<input id="mealUserName" style="width:300px;" name="$qc.like('mealUserName')" class="easyui-textbox" />
             	</td>
        	</tr>
			<tr>
				<td align="right">部门：</td>
				<td align="left" colspan="3">
					<input id="mealDeptName" style="width:300px;" name="$qc.like('mealDeptName')" class="easyui-textbox" />
             	</td>
        	</tr>
			<tr>
				<td align="right">状态：</td>
				<td align="left">
					<select name="$qc.equal('status')" class="easyui-combobox" data-options="editable:false" style="width:110px;"
						panelheight="auto">
						#set($arr = [1, 2])
						#formoptioncontain("" $dict.CarStatus $arr)
					</select>
				</td>
			</tr>
		</table>
	</form>
    <div id="bnts" style="top:0px; height:25px; width:auto;">
        <a class="new-but" onclick="formSerach()">确定</a>
        <a class="new-but" onclick="reset()">重置</a>
    </div>
</div>


<div id="editWindow" class="easyui-window" title="设置" style="width:450px;height:80%;padding:5px"
	data-options="closed:true,modal:true,minimizable:false,maximizable:false,collapsible:false">
</div>
#parse("common/easyui/operatorcolumn.js.vm")
#parse("common/button/control.js.vm")
#@script()
<script type="text/javascript">

	$('#tab').tabs({
  		onSelect: function(){
			var tab = $('#tab').tabs('getSelected');
			var index = $('#tab').tabs('getTabIndex',tab);
			if(index == 1){
				$("#print").show();
			}else{
				$("#print").hide();
			}
  		}
	});

	
	var _baseUrl = '$link.getContextURL()/pubaffairs/meal';
    var _listJsonUrl = '/listDetail.json';
	var _finishJsonUrl = '/doFinish.json';
	var _backJsonUrl = '/doBack.json';
	
	$(document).ready(function(){
		var _datagrid = $("#dg");
        var _querForm = $("#queryForm");
        var _toolbar = $("#tb");

        function addPageCondition(param){
            $.extend(param,getConditions());
        }
		
        function getConditions(){
            var f = _querForm.serializeArray();
            var searchConditions = {};
            for(var i = 0;i< f.length;i++){
                searchConditions[f[i].name] = f[i].value;
            }
            return searchConditions;
        }
		
		<!-----------------------工具条操作-------------------------------->
        var _btnFinish = $("[iconCls='icon-add']",_toolbar);
        var _btnBack = $("[iconCls='icon-edit']",_toolbar);
        if(_btnFinish){
            _btnFinish.on("click",doFinish);
        }
        if(_btnBack){
            _btnBack.on("click",doBack);
        }
		
		<!-----------------------办结操作-------------------------------->
		function doFinish(){
			var rows = $("#dg").datagrid("getChecked");
			if(rows && rows.length > 0){
                $.messager.confirm('提示','确定办结这些数据吗?',function(r){
                    if (r){
                        var ids = "";
                        for(var i=0;i<rows.length;i++){
                            if(i==rows.length-1){
                                ids += rows[i].id;
                            }else{
                                ids += rows[i].id + ",";
                            }
							
							if (rows[i].status == "办结") {
                                top.CC.messager({
                                    title: '提示',
                                    msg: '不能办结已办结的订餐!'
                                });
                                return;
                            }
                        }
                        top.CC.loading("请稍等....");
                        $.post(_baseUrl + (_finishJsonUrl || '/doFinish.json'),{ids:ids},function(result){
                            top.CC.loaded();
                            if (result.success){
                                $('#dg').datagrid('reload'); // reload the user data
                                top.CC.messager({ // show error message
                                    title: '成功',
                                    msg: '办结成功!'
                                });
                            } else {
                                top.CC.messager({ // show error message
                                    title: '提示',
                                    msg: result.errorMsg
                                });
                            }
                        },'json');
                    }
                });
            } else {
                top.CC.messager({
                    title: '提示',
                    msg: '请选择至少一条数据进行办结!'
                });
            }
		}
		<!-----------------------退回操作-------------------------------->
		function doBack(){
			var rows = $("#dg").datagrid("getChecked");
			if(rows && rows.length > 0){
                $.messager.confirm('提示','确定退回这些数据吗?',function(r){
                    if (r){
                        var ids = "";
                        for(var i=0;i<rows.length;i++){
                            if(i==rows.length-1){
                                ids += rows[i].id;
                            }else{
                                ids += rows[i].id + ",";
                            }
							
							if (rows[i].status == "在办") {
                                top.CC.messager({
                                    title: '提示',
                                    msg: '不能退回在办的订餐!'
                                });
                                return;
                            }
                        }
                        top.CC.loading("请稍等....");
                        $.post(_baseUrl + (_backJsonUrl || '/doBack.json'),{ids:ids},function(result){
                            top.CC.loaded();
                            if (result.success){
                                $('#dg').datagrid('reload'); // reload the user data
                                top.CC.messager({ // show error message
                                    title: '成功',
                                    msg: '退回成功!'
                                });
                            } else {
                                top.CC.messager({ // show error message
                                    title: '提示',
                                    msg: result.errorMsg
                                });
                            }
                        },'json');
                    }
                });
            } else {
                top.CC.messager({
                    title: '提示',
                    msg: '请选择至少一条数据进行退回!'
                });
            }
		}
        //初始化datagrid
        _datagrid.datagrid({
            fitColumns:true,//列宽自适应
            fit:true,//自适应
            nowrap:false,
            rownumbers:true,//行号
            singleSelect:false,//单选
            pagination:true,//显示分页工具条
            toolbar:'#tb',//工具条
            pageSize:20,//每页记录数
            pageList:[20,50,100,150],//可选每页记录数
            url:_baseUrl + (_listJsonUrl || '/list.json'),//获取数据的url
            onBeforeLoad:addPageCondition//提交查询时追加翻页条件
        });
    });

	<!-----------------------高级查询-------------------------------->
	function formSerach() {
		$('#searchDialog').window('close');
  		_datagrid.datagrid('reload');
   	}
	
	
	
	function reset(){
        var _qf = $("#queryForm");
        _qf.form("clear");
        $(".easyui-combobox",_qf).each(function(){
            $(this).combobox("select"," ");
        });
    }
	
		
    function getRowIdByDom(dom){
        var tr =$(dom).parent().parent().parent();
        return tr.attr("datagrid-row-index");
    }
	
	<!-----------------------格式化订餐状态-------------------------------->
	function statusShow(value,row) {
		if($.trim(row.status) == "暂存"){
            return "<font color='blue'>"+value+"</font>";
		}else if($.trim(row.status) == "在办"){
			return "<font color='red'>"+value+"</font>";
		}else{
			return "<font color='black'>"+value+"</font>";
		}
    }
	
</script>
#end